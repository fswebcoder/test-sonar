<div class="flex flex-column gap-4 w-full">
  <div class="m-0 flex flex-column gap-3">
    <label class="font-semibold uppercase">Agregar Análisis</label>
    <form
      [formGroup]="internalForm"
      class="flex flex-column md:flex-row gap-3 md:gap-2 align-items-stretch md:align-items-end"
    >
      <svi-float-select
        formControlName="selectedAnalysisId"
        label="Seleccionar análisis"
        [options]="getAvailableAnalysisTypes()"
        optionLabel="name"
        optionValue="id"
        [filter]="true"
        [showClear]="true"
        emptyMessage="No hay análisis disponibles"
        emptyFilterMessage="No se encontraron análisis"
        class="w-full md:flex-1"
      />
      <svi-button
        [icon]="ICONS.ADD"
        label="Agregar"
        (onClick)="addAnalysis()"
        [disabled]="!selectedAnalysisId?.value"
        styleClass="w-full md:w-auto"
      />
    </form>
  </div>

  @if (hasValidFormArray() && requiredAnalysesFormArray.length > 0) {
    <div class="p-3 flex flex-column gap-3">
      <label class="font-semibold uppercase">Análisis Seleccionados</label>
      <form [formGroup]="parentForm()">
        <div
          formArrayName="requiredAnalyses"
          class="grid gap-3 justify-content-center"
        >
          @for (analysisGroup of requiredAnalysesFormArray.controls; track $index; let i = $index) {
            <svi-analysis-card
              [analysisFormGroup]="getAnalysisFormGroup(i)"
              [analysisName]="getAnalysisName(getAnalysisFormGroup(i).get('analysisId')?.value)"
              [index]="i"
              (onRemove)="removeAnalysis($event)"
              class="col-12 sm:col-6 lg:col-4 xl:col-3"
            />
          }
        </div>
      </form>
    </div>
  } @else {
    <p-message severity="warn" class="w-full">
      <ng-template #icon>
        <i [class]="ICONS.WARNING + ' text-orange-500 text-xl'"></i>
      </ng-template>
      <span>No hay análisis seleccionados. Agregue al menos un análisis para continuar.</span>
    </p-message>
  }
</div>
